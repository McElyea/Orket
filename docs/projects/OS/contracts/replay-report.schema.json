{
  "$id": "https://orket.dev/os/contracts/replay-report.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ReplayReport",
  "description": "Replay and equivalence output for Orket Kernel v1. Deterministic parity results over local artifacts.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "contract_version",
    "mode",
    "outcome",
    "runs_compared",
    "turns_compared",
    "issues",
    "events",
    "parity"
  ],
  "properties": {
    "contract_version": { "const": "kernel_api/v1" },
    "mode": { "type": "string", "enum": ["replay_run", "compare_runs"] },
    "outcome": { "type": "string", "enum": ["PASS", "FAIL"] },

    "status": { "type": "string", "enum": ["MATCH", "DIVERGENT", "ERROR"] },
    "exit_code": {
      "anyOf": [
        { "type": "string", "pattern": "^[EI]_[A-Z0-9_]+$" },
        { "type": "null" }
      ],
      "default": null
    },
    "report_id": {
      "anyOf": [
        { "$ref": "#/$defs/StructuralDigest" },
        { "type": "null" }
      ],
      "default": null
    },

    "runs_compared": { "type": "integer", "minimum": 1 },
    "turns_compared": { "type": "integer", "minimum": 0 },

    "issues": {
      "type": "array",
      "items": { "$ref": "https://orket.dev/os/contracts/kernel-issue.schema.json" }
    },
    "events": {
      "type": "array",
      "items": { "type": "string" }
    },

    "mismatches_detail": {
      "type": "array",
      "description": "Deterministic mismatch records sorted by (turn_id, stage_index, ordinal, surface, path).",
      "items": { "$ref": "#/$defs/MismatchRecord" }
    },
    "digests": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "registry_digest": {
          "anyOf": [{ "$ref": "#/$defs/StructuralDigest" }, { "type": "null" }],
          "description": "May be null when comparator ends in schema/ERROR path."
        },
        "policy_digest": {
          "anyOf": [{ "$ref": "#/$defs/StructuralDigest" }, { "type": "null" }],
          "description": "May be null when comparator ends in schema/ERROR path."
        },
        "runtime_digest": {
          "anyOf": [{ "$ref": "#/$defs/StructuralDigest" }, { "type": "null" }],
          "description": "May be null when comparator ends in schema/ERROR path."
        }
      }
    },

    "parity": { "$ref": "#/$defs/ParityReport" }
  },
  "$defs": {
    "StructuralDigest": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
    "ParityReport": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "matches", "mismatches", "expected", "actual"],
      "properties": {
        "kind": { "type": "string", "enum": ["structural_parity"] },
        "matches": { "type": "integer", "minimum": 0 },
        "mismatches": { "type": "integer", "minimum": 0 },
        "expected": { "$ref": "#/$defs/ParitySide" },
        "actual": { "$ref": "#/$defs/ParitySide" }
      }
    },
    "ParitySide": {
      "type": "object",
      "additionalProperties": false,
      "required": ["run_id", "turn_digests"],
      "properties": {
        "run_id": { "type": "string", "minLength": 1 },
        "turn_digests": {
          "type": "array",
          "items": { "$ref": "#/$defs/TurnDigest" }
        }
      }
    },
    "TurnDigest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["turn_id", "turn_result_digest"],
      "properties": {
        "turn_id": { "type": "string", "minLength": 1 },
        "turn_result_digest": { "$ref": "#/$defs/StructuralDigest" },
        "evidence_digest": { "$ref": "#/$defs/StructuralDigest" }
      }
    },
    "MismatchRecord": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "turn_id",
        "stage_name",
        "surface",
        "path",
        "diagnostic"
      ],
      "properties": {
        "turn_id": { "type": "string", "minLength": 1 },
        "stage_name": {
          "type": "string",
          "enum": [
            "base_shape",
            "dto_links",
            "relationship_vocabulary",
            "policy",
            "determinism",
            "ci",
            "lsi",
            "promotion",
            "capability",
            "replay"
          ]
        },
        "stage_index": { "type": "integer", "minimum": 0 },
        "ordinal": { "type": "integer", "minimum": 0 },
        "surface": {
          "type": "string",
          "enum": [
            "registry_digest",
            "policy_digest",
            "runtime_digest",
            "turn_result_digest",
            "stage_outcome",
            "issue",
            "decision_record",
            "schema",
            "input"
          ]
        },
        "path": { "type": "string", "minLength": 1 },
        "expected_digest": { "anyOf": [{ "$ref": "#/$defs/StructuralDigest" }, { "type": "null" }] },
        "actual_digest": { "anyOf": [{ "$ref": "#/$defs/StructuralDigest" }, { "type": "null" }] },
        "diagnostic": {
          "anyOf": [
            { "type": "null" },
            { "type": "object", "additionalProperties": true }
          ],
          "description": "Diagnostic payload is excluded from report_id hash input via nullification."
        }
      }
    }
  }
}
